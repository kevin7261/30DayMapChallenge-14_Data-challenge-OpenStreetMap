<script>
  /**
   * ═══════════════════════════════════════════════════════════════════════════
   * 🗺️ MapTab.vue - Leaflet OSM 多圖層地圖組件
   * ═══════════════════════════════════════════════════════════════════════════
   *
   * @fileoverview
   * 這是一個基於 Leaflet 的多圖層地圖視覺化組件，使用 OpenStreetMap 數據和諾魯國旗配色主題。
   * 本組件負責載入、處理和渲染四種不同的地理數據圖層，並提供流暢的地圖交互體驗。
   *
   * ─────────────────────────────────────────────────────────────────────────
   * 📋 核心功能
   * ─────────────────────────────────────────────────────────────────────────
   * 1. 多圖層渲染：
   *    ✓ 地點圖層 (Places)：行政區劃、城市、村莊
   *    ✓ 水域圖層 (Water)：湖泊、河流、海洋
   *    ✓ 道路圖層 (Roads)：道路網絡
   *    ✓ 交通設施圖層 (Transport)：機場、港口、車站
   *
   * 2. 視覺元素：
   *    ✓ 經緯網格系統（每 10° 一條）
   *    ✓ 赤道線標示（金黃色，呼應諾魯國旗）
   *    ✓ 諾魯國旗配色主題（深藍、金黃、白色）
   *
   * 3. 交互功能：
   *    ✓ 滾輪縮放控制
   *    ✓ 拖動平移導航
   *    ✓ 觸控設備支持
   *    ✗ 禁用懸停效果（專注靜態呈現）
   *    ✗ 禁用彈出窗口（簡化交互）
   *
   * 4. 性能優化：
   *    ✓ 並行載入所有 GeoJSON 數據
   *    ✓ Canvas 渲染模式（preferCanvas: true）
   *    ✓ 非交互圖層設置（interactive: false）
   *
   * ─────────────────────────────────────────────────────────────────────────
   * 🎨 配色主題：諾魯國旗
   * ─────────────────────────────────────────────────────────────────────────
   * 諾魯深藍  #002B7F  → 地點填充色、水域邊框
   * 背景深藍  #001b4d  → 地圖背景、水域填充
   * 金黃色    #FFC61E  → 赤道線、道路、邊框
   * 白色      #FFFFFF  → 經緯網格、交通設施
   *
   * 選擇諾魯配色的原因：
   * - 諾魯是世界最小島國之一，與 OSM 細節呈現理念呼應
   * - 諾魯位於赤道附近，國旗黃色橫條正代表赤道
   * - 作為太平洋島國，配色與海洋主題完美契合
   *
   * ─────────────────────────────────────────────────────────────────────────
   * 📊 圖層渲染順序（由下至上）
   * ─────────────────────────────────────────────────────────────────────────
   * Layer 0: 經緯網格 (Graticule)         - 白色半透明參考線
   * Layer 1: 赤道線 (Equator)            - 金黃色強調線
   * Layer 2: 地點 (Places)               - 諾魯藍多邊形（底層）
   * Layer 3: 水域 (Water)                - 深藍色水體
   * Layer 4: 道路 (Roads)                - 金黃色線條
   * Layer 5: 交通設施 (Transport)        - 白色多邊形（頂層）
   *
   * ─────────────────────────────────────────────────────────────────────────
   * 🛠️ 技術棧
   * ─────────────────────────────────────────────────────────────────────────
   * @requires vue                 - Vue 3.2+ (Composition API)
   * @requires leaflet             - Leaflet 1.9+ (地圖渲染庫)
   * @requires @/stores/dataStore  - Pinia 狀態管理
   *
   * ─────────────────────────────────────────────────────────────────────────
   * 📁 數據來源
   * ─────────────────────────────────────────────────────────────────────────
   * 所有 GeoJSON 數據來自 OpenStreetMap (ODbL License)
   * 路徑：public/data/geojson/*.geojson
   *
   * ─────────────────────────────────────────────────────────────────────────
   * 🔧 使用方式
   * ─────────────────────────────────────────────────────────────────────────
   * <MapTab @map-ready="handleMapReady" />
   *
   * @event map-ready - 地圖初始化完成時觸發，返回地圖實例
   *
   * ─────────────────────────────────────────────────────────────────────────
   * 📝 維護者
   * ─────────────────────────────────────────────────────────────────────────
   * @author Kevin Cheng
   * @version 2.0.0
   * @since 2024
   * @license MIT
   *
   * ═══════════════════════════════════════════════════════════════════════════
   */

  // ═══════════════════════════════════════════════════════════════════════════
  // 📦 依賴導入 (Dependencies Import)
  // ═══════════════════════════════════════════════════════════════════════════

  // Vue 3 核心功能
  import { ref, onMounted, onUnmounted, nextTick } from 'vue';

  // Leaflet 地圖庫及樣式
  import L from 'leaflet';
  import 'leaflet/dist/leaflet.css';

  // Pinia 狀態管理
  import { useDataStore } from '@/stores/dataStore';

  // ═══════════════════════════════════════════════════════════════════════════
  // 🎯 組件定義 (Component Definition)
  // ═══════════════════════════════════════════════════════════════════════════

  export default {
    name: 'MapTab',

    // 組件觸發的事件
    emits: [
      'map-ready', // 地圖初始化完成時觸發，傳遞地圖實例
    ],

    /**
     * ───────────────────────────────────────────────────────────────────────
     * 🎬 組件設置函數 (Component Setup Function)
     * ───────────────────────────────────────────────────────────────────────
     * 使用 Vue 3 Composition API 設置組件邏輯
     *
     * @param {Object} _ - Props（本組件不使用）
     * @param {Object} context - 設置上下文
     * @param {Function} context.emit - 事件觸發函數
     * @returns {Object} 返回模板可用的響應式數據和方法
     */
    setup(_, { emit }) {
      // ═══════════════════════════════════════════════════════════════════════
      // 📦 狀態管理與依賴 (State Management & Dependencies)
      // ═══════════════════════════════════════════════════════════════════════

      /**
       * Pinia 數據存儲實例
       * 用於存儲和共享地圖實例
       */
      const dataStore = useDataStore();

      // ═══════════════════════════════════════════════════════════════════════
      // 🗺️ 地圖相關變數 (Map-Related Variables)
      // ═══════════════════════════════════════════════════════════════════════

      /**
       * 地圖 DOM 容器引用
       * @type {Ref<HTMLElement|null>}
       */
      const mapContainer = ref(null);

      /**
       * Leaflet 地圖實例
       * 初始化後包含完整的地圖 API
       * @type {L.Map|null}
       */
      let map = null;

      /**
       * 地點圖層實例（Places Layer）
       * 包含行政區劃、城市、村莊等多邊形數據
       * @type {L.GeoJSON|null}
       */
      // eslint-disable-next-line no-unused-vars
      let placesLayer = null;

      // ═══════════════════════════════════════════════════════════════════════
      // 🎛️ 控制狀態 (Control States)
      // ═══════════════════════════════════════════════════════════════════════

      /**
       * 地圖就緒狀態標記
       * true = 地圖已初始化完成，false = 尚未初始化
       * @type {Ref<boolean>}
       */
      const isMapReady = ref(false);

      /**
       * 地圖容器唯一 ID
       * 使用隨機字符串確保多實例時不會衝突
       * @type {Ref<string>}
       */
      const mapContainerId = ref(`leaflet-map-${Math.random().toString(36).substr(2, 9)}`);

      // ═══════════════════════════════════════════════════════════════════════
      // 📊 GeoJSON 數據儲存 (GeoJSON Data Storage)
      // ═══════════════════════════════════════════════════════════════════════

      /**
       * 地點 GeoJSON 數據
       * 來源：gis_osm_places_a_free_1.geojson
       * @type {Ref<Object|null>}
       */
      const placesData = ref(null);

      /**
       * 📥 載入 OSM 地點 GeoJSON 數據
       */
      const loadPlacesData = async () => {
        try {
          console.log('[MapTab] 開始載入 OSM 地點 GeoJSON 數據...');

          // 載入地點 GeoJSON 檔案
          const placesResponse = await fetch(
            `${process.env.BASE_URL}data/geojson/gis_osm_places_a_free_1.geojson`
          );

          // 檢查響應
          if (!placesResponse.ok) {
            throw new Error(`地點數據載入失敗: HTTP ${placesResponse.status}`);
          }

          // 解析 JSON
          placesData.value = await placesResponse.json();

          console.log('[MapTab] OSM 地點數據載入成功');
          console.log('  - 地點數量:', placesData.value.features?.length || 0);

          return true;
        } catch (error) {
          console.error('[MapTab] OSM 地點數據載入失敗:', error);
          return false;
        }
      };

      /**
       * 🌍 繪製赤道線
       */
      const drawEquator = () => {
        if (!map) return;

        // 創建赤道線（緯度 0°）- 使用諾魯國旗的金黃色
        // 諾魯國旗上的黃色橫條代表赤道
        const equatorCoords = [
          [0, -180],
          [0, 180],
        ];

        L.polyline(equatorCoords, {
          color: '#FFC61E', // 金黃色（諾魯國旗配色）
          weight: 4,
          opacity: 1,
          interactive: false,
        }).addTo(map);

        console.log('[MapTab] 赤道線繪製完成');
      };

      /**
       * 🏗️ 創建地圖實例
       * 初始化 Leaflet 地圖並設定基本配置
       */
      const createMap = () => {
        if (!mapContainer.value) return false;

        const rect = mapContainer.value.getBoundingClientRect();
        if (rect.width === 0 || rect.height === 0) {
          console.warn('[MapTab] 容器尺寸為零，延遲初始化');
          return false;
        }

        try {
          // 諾魯（Nauru）位置：緯度 -0.5228°, 經度 166.9315°
          // 赤道位置：緯度 0°
          // 中心點：赤道與諾魯之間 = 緯度 -0.26°, 經度 166.93°

          // 創建 Leaflet 地圖（不使用底圖，不顯示縮放按鈕）
          map = L.map(mapContainer.value, {
            center: [-0.26, 166.93], // 中心點在赤道與諾魯之間
            zoom: 10, // 較近的縮放級別，可以清楚看到赤道線和諾魯細節
            zoomControl: false, // 不顯示 +/- 按鈕
            attributionControl: false, // 不顯示歸屬信息
            preferCanvas: true, // 使用 Canvas 渲染以提高性能
          });

          // 存儲地圖實例到 store
          dataStore.setMapInstance(map);

          isMapReady.value = true;

          // 將地圖實例傳遞給父組件
          emit('map-ready', { map });

          console.log('[MapTab] Leaflet 地圖創建成功');
          return true;
        } catch (error) {
          console.error('[MapTab] Leaflet 地圖創建失敗:', error);
          return false;
        }
      };

      /**
       * 🎨 繪製 OSM 地點圖層
       */
      const drawPlaces = () => {
        if (!map || !placesData.value) {
          console.error('[MapTab] 無法繪製地點: map=', !!map, 'placesData=', !!placesData.value);
          return;
        }

        try {
          console.log('[MapTab] 開始繪製地點，數量:', placesData.value.features?.length);

          // 創建 GeoJSON 圖層（使用諾魯國旗的白色）
          placesLayer = L.geoJSON(placesData.value, {
            style: {
              fillColor: '#FFFFFF', // 白色填充（諾魯國旗配色）
              fillOpacity: 0.9,
              color: '#FFFFFF', // 白色邊框
              weight: 1,
            },
            interactive: false, // 禁用所有交互功能
          }).addTo(map);

          // 不自動調整地圖視野，保持中心點在赤道與諾魯之間

          console.log(
            '[MapTab] OSM 地點繪製完成，已繪製',
            placesData.value.features?.length,
            '個地點'
          );
        } catch (error) {
          console.error('[MapTab] OSM 地點繪製失敗:', error);
        }
      };

      /**
       * 🚀 初始化地圖
       * 創建地圖並載入初始數據
       */
      const initMap = async () => {
        let attempts = 0;
        const maxAttempts = 20;

        // 載入 OSM 地點數據
        const loaded = await loadPlacesData();
        if (!loaded) {
          console.error('[MapTab] 無法載入 OSM 地點數據');
          return;
        }

        const tryCreateMap = async () => {
          if (attempts >= maxAttempts) {
            console.error('[MapTab] 地圖初始化失敗，已達到最大嘗試次數');
            return;
          }

          attempts++;
          console.log(`[MapTab] 嘗試創建地圖 (${attempts}/${maxAttempts})`);

          if (createMap()) {
            console.log('[MapTab] 地圖創建成功，開始繪製圖層');
            // 繪製赤道線（金黃色）
            drawEquator();
            // 繪製地點圖層（白色）
            drawPlaces();
          } else {
            console.log('[MapTab] 地圖創建失敗，100ms 後重試');
            setTimeout(tryCreateMap, 100);
          }
        };

        tryCreateMap();
      };

      // 🧹 生命週期：組件掛載
      onMounted(() => {
        nextTick(() => {
          initMap();
        });
      });

      // 🧹 生命週期：組件卸載
      onUnmounted(() => {
        if (map) {
          map.remove();
          map = null;
        }

        placesLayer = null;
        isMapReady.value = false;
      });

      // 📤 返回組件公開的屬性和方法
      return {
        mapContainer,
        mapContainerId,
      };
    },
  };
</script>

<template>
  <!-- 🗺️ 地圖主容器 -->
  <div id="map-container" class="h-100 w-100 position-relative bg-transparent z-0">
    <!-- 🗺️ Leaflet 地圖容器 -->
    <div :id="mapContainerId" ref="mapContainer" class="h-100 w-100"></div>
  </div>
</template>

<style scoped>
  @import '../assets/css/common.css';

  #map-container {
    overflow: hidden;
  }

  :deep(.leaflet-container) {
    background: #001b4d; /* 深藍色背景（諾魯國旗主題） */
  }

  :deep(.leaflet-popup-content-wrapper) {
    background: rgba(0, 43, 127, 0.95); /* 諾魯深藍色半透明 */
    color: #ffc61e; /* 金黃色文字 */
    border: 2px solid #ffc61e; /* 金黃色邊框 */
  }

  :deep(.leaflet-popup-tip) {
    background: rgba(0, 43, 127, 0.95); /* 諾魯深藍色半透明 */
  }

  :deep(.leaflet-tooltip) {
    background-color: rgba(0, 43, 127, 0.95) !important; /* 諾魯深藍色 */
    color: #ffc61e !important; /* 金黃色文字 */
    border: 1px solid #ffc61e !important; /* 金黃色邊框 */
    font-size: 14px;
    padding: 8px 12px;
    border-radius: 4px;
    line-height: 1.4;
  }

  :deep(.map-tooltip) {
    background-color: rgba(0, 43, 127, 0.95); /* 諾魯深藍色 */
    color: #ffc61e; /* 金黃色文字 */
    border: 1px solid #ffc61e; /* 金黃色邊框 */
    padding: 8px 12px;
    border-radius: 4px;
    font-size: 14px;
    line-height: 1.4;
  }
</style>
